import aiohttp
import random
import re
from typing import List, Dict
import logging

logger = logging.getLogger(__name__)

class FreeAIService:
    """ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุฌุงููุฉ"""
    
    def __init__(self):
        self.knowledge_base = self._create_knowledge_base()
        
    def _create_knowledge_base(self) -> Dict:
        """ุฅูุดุงุก ูุงุนุฏุฉ ูุนุฑููุฉ ุนุฑุจูุฉ ุดุงููุฉ"""
        return {
            # ุชูููุฉ
            "ุงูุฐูุงุก ุงูุงุตุทูุงุนู": "ูู ูุฑุน ูู ุนููู ุงูุญุงุณูุจ ููุฏู ูุตูุน ุฃูุธูุฉ ุฐููุฉ ุชุญุงูู ุงูุฐูุงุก ุงูุจุดุฑู.",
            "ุจุงูุซูู": "ูุบุฉ ุจุฑูุฌุฉ ุนุงููุฉ ุงููุณุชููุ ุณููุฉ ุงูุชุนููุ ุชุณุชุฎุฏู ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุทููุฑ ุงูููุจ.",
            "html": "ูุบุฉ ุชุฑููุฒ ูุฅูุดุงุก ุตูุญุงุช ุงูููุจุ ุชุจุฏุฃ ุจู <html> ูุชูุชูู ุจู </html>.",
            "css": "ูุบุฉ ุชูุณูู ูุตูุญุงุช ุงูููุจุ ุชุชุญูู ูู ุงูุฃููุงู ูุงูุฎุทูุท ูุงูุชุฎุทูุท.",
            "ุฌุงูุง ุณูุฑูุจุช": "ูุบุฉ ุจุฑูุฌุฉ ุชุฌุนู ุตูุญุงุช ุงูููุจ ุชูุงุนููุฉ.",
            "github": "ููุตุฉ ููุดุงุฑูุฉ ุงูููุฏ ุงูุจุฑูุฌู ูุงูุชุนุงูู ุจูู ุงููุทูุฑูู.",
            
            # ุนููู
            "ุงููุถุงุก": "ุงููุถุงุก ุงูุฎุงุฑุฌู ูุจุฏุฃ ูู 100 ูู ููู ุงูุฃุฑุถุ ููุญุชูู ุนูู ุงูููุงูุจ ูุงููุฌูู.",
            "ุงูุทุงูุฉ ุงูุดูุณูุฉ": "ุทุงูุฉ ูุธููุฉ ุชุฃุชู ูู ุงูุดูุณุ ูููู ุชุญููููุง ูููุฑุจุงุก.",
            
            # ุชุนููู
            "ููู ุงุชุนูู ุจุฑูุฌุฉ": "ุงุจุฏุฃ ุจูุบุฉ ุณููุฉ ูุซู ุจุงูุซููุ ุชุฏุฑุจ ุนูู ูุดุงุฑูุน ุตุบูุฑุฉุ ุงุณุชุฎุฏู ููุตุงุช ูุซู Codecademy.",
            "ุงูุถู ูุบุฉ ุจุฑูุฌุฉ": "ูุง ููุฌุฏ ุฃูุถู ูุบุฉุ ูู ูุบุฉ ููุงุณุจุฉ ููุฌุงู ูุนูู. ุจุงูุซูู ููุฐูุงุก ุงูุงุตุทูุงุนูุ ุฌุงูุง ุณูุฑูุจุช ููููุจ.",
            
            # ุนุงู
            "ุงูุณูุงู ุนูููู": "ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            "ูุฑุญุจุง": "ูุฑุญุจุงู ุจู! ุฃูุง ูุณุงุนุฏู ุงูุฐูู ุงููุฌุงูู. ููู ูููููู ุฎุฏูุชูุ",
            "ุดูุฑุง": "ุงูุนูู! ุฏุงุฆูุงู ุณุนูุฏ ุจุงููุณุงุนุฏุฉ. ูู ุชุญุชุงุฌ ุฃู ุดูุก ุขุฎุฑุ",
        }
    
    async def chat(self, message: str) -> str:
        """ูุญุงุฏุซุฉ ุฐููุฉ ูุฌุงููุฉ"""
        # ุชูุธูู ุงูุฑุณุงูุฉ
        msg_lower = message.lower().strip()
        
        # ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
        for key, value in self.knowledge_base.items():
            if key.lower() in msg_lower:
                return value
        
        # ุฅุฐุง ูุงู ุณุคุงู ููุงุฐุง ุฃู ููู
        if msg_lower.startswith(('ููุงุฐุง', 'ููู', 'ูุง ูู', 'ูุง ูู')):
            return self._generate_smart_response(message)
        
        # ุฑุฏูุฏ ุนุงูุฉ
        general_responses = [
            f"ุณุคุงู ูุซูุฑ! '{message}' - ูููููู ูุณุงุนุฏุชู ูู:\n1. ุดุฑุญ ููุงููู ุชูููุฉ\n2. ุงูุจุญุซ ุนู ูุนูููุงุช\n3. ุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุฉ ุนุงูุฉ\nุงุณุชุฎุฏู /ask ููุณุคุงู ุฃู /search ููุจุญุซ.",
            f"๐ก '{message}' - ุฌุฑุจ ุงูุจุญุซ ุนู ูุฐุง ุงูููุถูุน ุนุจุฑ:\nโข ููููุจูุฏูุง ุงูุนุฑุจูุฉ\nโข ููุตุงุช ุงูุชุนููู ุงููุฌุงููุฉ\nโข ุงููุฏููุงุช ุงูุชูููุฉ\nุงุณุชุฎุฏู /wiki ููุจุญุซ ูู ููููุจูุฏูุง.",
            f"ูููููู ูุณุงุนุฏุชู ูู:\nโข ุงูุจุฑูุฌุฉ ูุงูุชูููุฉ\nโข ุงูุนููู ูุงููุนุฑูุฉ\nโข ุงูุจุญุซ ุนู ุงููุนูููุงุช\n๐ก ุฌุฑุจ: /ask {message}"
        ]
        
        return random.choice(general_responses)
    
    def _generate_smart_response(self, question: str) -> str:
        """ุฅูุดุงุก ุฑุฏ ุฐูู ููุณุคุงู"""
        if 'ุจุฑูุฌุฉ' in question.lower():
            return "ูุชุนูู ุงูุจุฑูุฌุฉ:\n1. ุงุฎุชุฑ ูุบุฉ (ูุซู Python)\n2. ุชุนูู ุงูุฃุณุงุณูุงุช\n3. ุชุฏุฑุจ ุนูู ูุดุงุฑูุน ุตุบูุฑุฉ\n4. ุงูุถู ููุฌุชูุนุงุช ุงููุทูุฑูู\n5. ุงุณุชูุฑ ูู ุงูุชุนูู"
        
        elif 'ุฐูุงุก ุงุตุทูุงุนู' in question.lower():
            return "ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุนูู ูู ุงูุจูุงูุงุช ูุงุชุฎุงุฐ ูุฑุงุฑุงุช. ูุณุชุฎุฏู ูู:\nโข ุงูุชูุตูุงุช (Netflix)\nโข ุงูุณูุงุฑุงุช ุงูุฐุงุชูุฉ\nโข ุงููุณุงุนุฏุงุช ุงูุตูุชูุฉ\nโข ุงูุชุดุฎูุต ุงูุทุจู"
        
        else:
            return f"ุณุคุงู ููู ุนู '{question}'.\nููููู:\n1. ุงูุจุญุซ ูู ุงูุฅูุชุฑูุช: /search {question}\n2. ุงูุงุทูุงุน ุนูู ููููุจูุฏูุง: /wiki {question}\n3. ุทุฑุญ ุณุคุงู ูุญุฏุฏ: /ask {question}"
    
    async def get_answer(self, question: str) -> str:
        """ุงูุญุตูู ุนูู ุฅุฌุงุจุฉ ูุณุคุงู"""
        return await self.chat(question)
    
    async def search_internet(self, query: str) -> List[Dict]:
        """ุจุญุซ ูุจุณุท ูู ุงูุฅูุชุฑูุช"""
        # ูุฐู ุฏุงูุฉ ุจุฏููุฉ ููุจุญุซ ุงูุณุฑูุน
        return [
            {
                "title": f"ูุนูููุงุช ุนู {query}",
                "snippet": f"ููููู ุงูุจุญุซ ุนู '{query}' ูู:\n1. ููููุจูุฏูุง ุงูุนุฑุจูุฉ\n2. ูุญุฑูุงุช ุงูุจุญุซ\n3. ุงูููุตุงุช ุงูุชุนููููุฉ",
                "url": ""
            }
        ]
